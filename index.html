<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>simple-chat-app</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      #uf { background: white; padding: 0px; position: absolute; width: 100%;height: 100%; z-index: 3;}

    </style>

    <link rel="stylesheet" href="styles/izitoast/iziToast.min.css">
    <link rel="stylesheet" href="styles/chat-bubble.css">
    <script src="scripts/izitoast/iziToast.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/solid.css" integrity="sha384-Rw5qeepMFvJVEZdSo1nDQD5B6wX0m7c5Z/pLNvjkB14W6Yki1hKbSEQaX9ffUbWe" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/fontawesome.css" integrity="sha384-GVa9GOgVQgOk+TNYXu7S/InPTfSDTtBalSgkgqQ7sCik56N9ztlkoTr2f/T44oKV" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function(){
          var socket = io();
          var user;
          var socket_id;

        socket.on('new_message', function(msg){
          var msgp = msg.split(",");

          if (String(socket_id) === String(msgp[2])) {
              $('#message_container').append($('<div class="bubble you">').text(msgp[1]));
          }
          else {
            $('#message_container').append($('<div class="bubble me">').text(msgp[0]+msgp[1]));
          }
          window.scrollTo(0,document.body.scrollHeight);
        });
        socket.on('new_user', function(username){
          iziToast.success({
            title: username,
            message: 'çevrimiçi oldu!',
            position: 'topRight',
            timeout: 2500,
            icon: 'fas fa-globe',
          });
        });
        socket.on('connect', function(){
            socket_id = socket.id;
            iziToast.show({
              title: 'GİRİŞ',
              timeout: false,
              overlay: true,
              theme: 'dark',
              zindex: 999,
              icon: 'icon-person',
              title: 'Hoşgeldiniz',
              message: 'Mesaj yazabilmek için lütfen sizi tanıtan bir isim giriniz!',
              position: 'center',
              drag: false,
              close: false,
              progressBarColor: 'rgb(0, 255, 184)',
              inputs: [
                  ['<input type="text">', 'keyup', function (instance, toast, input, e) {
                      console.info(input.value);
                  }, true],
              ],
              buttons: [
                  ['<button>Giriş</button>', function (instance, toast, button, e, inputs) {
                    console.info(socket_id);
                    if (inputs[0].value.length > 3) {
                        user = inputs[0].value;
                        socket.emit('new_user', user);
                        instance.hide({
                            transitionOut: 'fadeOutUp'
                            }, toast, 'Kapat');
                    }
                    else{
                      iziToast.warning({
                        id: 'no_usr',
                        toastOnce: true,
                        title: 'Hata',
                        message: 'Lütfen en az 3 karakter giriniz!',
                        position: 'center',
                        timeout: 1000
                      });
                    }
                  }, true]
              ],
              onOpening: function(instance, toast){
                  console.info('İsim Bekleniyor!');
              },
              onClosing: function(instance, toast, closedBy){
                  console.info('closedBy: ' + closedBy);
                  iziToast.show({
                    title: user,
                    timeout: false,
                    theme: 'dark',
                    zindex: 999,
                    position: 'bottomCenter',
                    target: '.text_area',
                    close: false,
                    drag: false,
                    inputs: [
                        ['<input type="text">', 'keyup', function (instance, toast, input, e) {
                            console.info(input.value);
                        }, true]
                      ],
                    buttons: [
                        ['<button>GÖNDER</button>', function(instance, toast, button, e, inputs){
                          if (inputs[0].value.length > 2) socket.emit('new_message',user+" : ,"+inputs[0].value);
                          else{
                              iziToast.warning({
                                id: 'no_msg',
                                title: 'Hata',
                                toastOnce: true,
                                message: 'Boş mesaj Gönderemezsiniz',
                                position: 'bottomCenter',
                                target: '#message_container',
                                timeout: 1000
                              });
                          }
                          inputs[0].value = " ";
                        },]
                    ]
                });
              }
            });
        });
        socket.on('user_gone',function(username){
          iziToast.warning({
            title: username,
            message: 'çevrimdışı oldu!',
            position: 'topRight',
            timeout: 2500,
            icon: 'fas fa-walking',
          });
        });
      });
    </script>
  </head>
  <body>
    <div id="message_container" style="position:relative; bottom:0; padding-bottom:100px;"></div>
    <div class="text_area" style="position:fixed;bottom:0;"></div>
  </body>
</html>
